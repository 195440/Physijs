!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):t.physijs=s()}(this,function(){"use strict";function t(t,s){THREE.Scene.call(this),this.initializeWorker(t,s),this.physijs={is_stepping:!1,id_rigid_body_map:{},onStep:null}}function s(){return n++}function i(t,i,e){if(null==e)throw new Error("Physijs: attempted to create rigid body without specifying mass");THREE.Mesh.call(this,t,i),this.rotationAutoUpdate=!1,this.matrixAutoUpdate=!1,this.physijs={id:s(),mass:e||1/0}}function e(t,s,e){i.call(this,t,s,e)}function o(t){var s,i={};if(!(t instanceof e))throw new Error("Physijs: unable to determine rigid body definition for mesh");return t.geometry.computeBoundingSphere(),s=r.SPHERE,i.radius=t.geometry.boundingSphere.radius,{body_id:t.physijs.id,body_type:s,body_definition:i,mass:t.physijs.mass}}t.prototype=Object.create(THREE.Scene.prototype),t.prototype.constructor=t;var p={REPORTS:{WORLD:0},INITIALIZE:"INITIALIZE",ADD_RIGIDBODY:"ADD_RIGIDBODY",SET_RIGIDBODY_MASS:"SET_RIGIDBODY_MASS",SET_RIGIDBODY_POSITION:"SET_RIGIDBODY_POSITION",STEP_SIMULATION:"STEP_SIMULATION"};t.prototype.initializeWorker=function(t,s){this.worker=new Worker(t),this.worker.addEventListener("message",function(t){var s=t.data;if(s instanceof Float32Array){var i=s[0];i===p.REPORTS.WORLD&&this.processWorldReport(s)}}.bind(this)),this.postMessage(p.INITIALIZE,s||{})},t.prototype.processWorldReport=function(t){for(var s=t[1],i=0;s>i;i++){var e=2+17*i,o=t[e++],p=this.physijs.id_rigid_body_map[o];p.matrix.set(t[e++],t[e++],t[e++],t[e++],t[e++],t[e++],t[e++],t[e++],t[e++],t[e++],t[e++],t[e++],t[e++],t[e++],t[e++],t[e++])}if(this.postReport(t),this.physijs.is_stepping=!1,this.physijs.onStep instanceof Function){var r=this.physijs.onStep;this.physijs.onStep=null,r.call(this)}},t.prototype.postMessage=function(t,s){this.worker.postMessage({type:t,parameters:s})},t.prototype.postReport=function(t){this.worker.postMessage(t,[t.buffer])};var r={SPHERE:"SPHERE"},n=0;i.prototype=Object.create(THREE.Mesh.prototype),i.prototype.constructor=i,Object.defineProperty(i.prototype,"mass",{get:function(){return this.physijs.mass},set:function(t){this.physijs.mass=t,null!=this.parent&&this.parent.setRigidBodyMass(this)}}),e.prototype=Object.create(i.prototype),e.prototype.constructor=e,t.prototype.add=function(t){if(THREE.Scene.prototype.add.call(this,t),t instanceof i){var s=o(t);this.physijs.id_rigid_body_map[s.body_id]=t,this.postMessage(p.ADD_RIGIDBODY,s),this.postMessage(p.SET_RIGIDBODY_POSITION,{body_id:s.body_id,position:{x:t.position.x,y:t.position.y,z:t.position.z}})}},t.prototype.setRigidBodyMass=function(t){this.postMessage(p.SET_RIGIDBODY_MASS,{body_id:t.physijs.id,mass:t.physijs.mass})},t.prototype.step=function(t,s,i){if(this.physijs.is_stepping===!0)throw new Error("Physijs: scene is already stepping, cannot call step() until it's finished");this.physijs.is_stepping=!0,this.physijs.onStep=i,this.postMessage(p.STEP_SIMULATION,{time_delta:t,max_step:s})};var a={Mesh:i,SphereMesh:e,Scene:t};return a});