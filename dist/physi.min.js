!function(i,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):i.physijs=t()}(this,function(){"use strict";function i(i){this.physijs.postMessage(P.SET_RIGIDBODY_ANGULAR_FACTOR,{body_id:i.physics._.id,factor:{x:i.physics.angular_factor.x,y:i.physics.angular_factor.y,z:i.physics.angular_factor.z}})}function t(i){this.physijs.postMessage(P.SET_RIGIDBODY_LINEAR_FACTOR,{body_id:i.physics._.id,factor:{x:i.physics.linear_factor.x,y:i.physics.linear_factor.y,z:i.physics.linear_factor.z}})}function s(i){this.physijs.postMessage(P.SET_RIGIDBODY_ANGULAR_VELOCITY,{body_id:i.physics._.id,velocity:{x:i.physics.angular_velocity.x,y:i.physics.angular_velocity.y,z:i.physics.angular_velocity.z}})}function e(i){this.physijs.postMessage(P.SET_RIGIDBODY_LINEAR_VELOCITY,{body_id:i.physics._.id,velocity:{x:i.physics.linear_velocity.x,y:i.physics.linear_velocity.y,z:i.physics.linear_velocity.z}})}function n(i){this.physijs.postMessage(P.SET_RIGIDBODY_TRANSFORM,{body_id:i.physics._.id,position:{x:i.position.x,y:i.position.y,z:i.position.z},rotation:{x:i.quaternion.x,y:i.quaternion.y,z:i.quaternion.z,w:i.quaternion.w}})}function o(i){this.physijs.postMessage(P.SET_RIGIDBODY_COLLISION_MASK,{body_id:i._.id,collision_mask:i._.collision_mask})}function r(i){this.physijs.postMessage(P.SET_RIGIDBODY_COLLISION_GROUPS,{body_id:i._.id,collision_groups:i._.collision_groups})}function a(i){this.physijs.postMessage(P.SET_RIGIDBODY_ANGULAR_DAMPING,{body_id:i._.id,damping:i._.angular_damping})}function c(i){this.physijs.postMessage(P.SET_RIGIDBODY_LINEAR_DAMPING,{body_id:i._.id,damping:i._.linear_damping})}function p(i){this.physijs.postMessage(P.SET_RIGIDBODY_FRICTION,{body_id:i._.id,friction:i._.friction})}function _(i){this.physijs.postMessage(P.SET_RIGIDBODY_RESTITUTION,{body_id:i._.id,restitution:i._.restitution})}function h(i){this.physijs.postMessage(P.SET_RIGIDBODY_MASS,{body_id:i._.id,mass:i._.mass})}function y(i){this.physijs.worker.postMessage(i,[i.buffer])}function l(i,t){this.physijs.worker.postMessage({type:i,parameters:t})}function u(i){for(var t=i[1],s=0;t>s;s+=15){var e=s+2,n=this.physijs.id_body_map[i[e+0]],o=this.physijs.id_body_map[i[e+1]];null!=n&&null!=o&&(F.set(i[e+2],i[e+3],i[e+4]),U.set(i[e+5],i[e+6],i[e+7]),H.set(i[e+8],i[e+9],i[e+10]),V.set(i[e+11],i[e+12],i[e+13]),n.dispatchEvent({type:"physics.newContact",other_body:o,contact_point:F,contact_normal:U,relative_linear_velocity:H,relative_angular_velocity:V,penetration_depth:i[e+14]}),o.dispatchEvent({type:"physics.newContact",other_body:n,contact_point:F,contact_normal:U,relative_linear_velocity:H,relative_angular_velocity:V,penetration_depth:i[e+14]}))}this.physijs.postReport(i)}function d(i){for(var t=i[1],s=i[2],e=0;s>e;e++){var n=3+30*e,o=i[n++],r=this.physijs.id_body_map[o];null!=r&&(r.matrix.set(i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++],i[n++]),r.position.copy(r.physics._.position.set(i[n++],i[n++],i[n++])),r.quaternion.copy(r.physics._.quaternion.set(i[n++],i[n++],i[n++],i[n++])),r.physics.linear_velocity.copy(r.physics._.linear_velocity.set(i[n++],i[n++],i[n++])),r.physics.angular_velocity.copy(r.physics._.angular_velocity.set(i[n++],i[n++],i[n++])))}if(this.physijs.postReport(i),this.physijs.is_stepping=!1,this.physijs.onStep instanceof Function){var a=this.physijs.onStep;this.physijs.onStep=null,a.call(this,t)}}function g(i,t){this.physijs.worker=new Worker(i),this.physijs.worker.addEventListener("message",function(i){var t=i.data;if(t instanceof Float32Array){var s=t[0];s===P.REPORTS.WORLD?this.physijs.processWorldReport(t):s===P.REPORTS.COLLISIONS&&this.physijs.processCollisionReport(t)}}.bind(this)),this.physijs.postMessage(P.INITIALIZE,t||{})}function R(R,I){THREE.Scene.call(this),this.physijs={is_stepping:!1,id_body_map:{},onStep:null,initializeWorker:g.bind(this),processWorldReport:d.bind(this),processCollisionReport:u.bind(this),postMessage:l.bind(this),postReport:y.bind(this),setRigidBodyMass:h.bind(this),setRigidBodyRestitution:_.bind(this),setRigidBodyFriction:p.bind(this),setRigidBodyLinearDamping:c.bind(this),setRigidBodyAngularDamping:a.bind(this),setRigidBodyCollisionGroups:r.bind(this),setRigidBodyCollisionMask:o.bind(this),setRigidBodyTransform:n.bind(this),setRigidBodyLinearVelocity:e.bind(this),setRigidBodyAngularVelocity:s.bind(this),setRigidBodyLinearFactor:t.bind(this),setRigidBodyAngularFactor:i.bind(this)},this.physijs.initializeWorker(R,I)}function I(i){var t=i.physics.getShapeDefinition(i.physics.geometry);return{body_id:i.physics._.id,shape_definition:t,mass:i.physics._.mass,restitution:i.physics._.restitution,friction:i.physics._.friction,linear_damping:i.physics._.linear_damping,angular_damping:i.physics._.angular_damping,collision_groups:i.physics._.collision_groups,collision_mask:i.physics._.collision_mask}}function f(){return k++}function E(i,t,s,e){s=s||{},this.three_object=i,this.geometry=t,this.getShapeDefinition=e,this.linear_velocity=new THREE.Vector3,this.angular_velocity=new THREE.Vector3,this.linear_factor=new THREE.Vector3(1,1,1),this.angular_factor=new THREE.Vector3(1,1,1),this._={id:f(),mass:s.mass||1/0,restitution:s.restitution||.1,friction:s.friction||.5,linear_damping:s.linear_damping||0,angular_damping:s.angular_damping||0,collision_groups:s.collision_groups||0,collision_mask:s.collision_mask||0,position:new THREE.Vector3,quaternion:new THREE.Quaternion,linear_velocity:new THREE.Vector3,angular_velocity:new THREE.Vector3,linear_factor:new THREE.Vector3(1,1,1),angular_factor:new THREE.Vector3(1,1,1)},this.clone=function(i){var n=new E(i,t,s,e);return n.mass=this.mass,n.restitution=this.restitution,n.friction=this.friction,n.linear_damping=this.linear_damping,n.angular_damping=this.angular_damping,n.collision_groups=this.collision_groups,n.collision_mask=this.collision_mask,n.linear_velocity.copy(this.linear_velocity),n.angular_velocity.copy(this.angular_velocity),n.linear_factor.copy(this.linear_factor),n.angular_factor.copy(this.angular_factor),n}}function O(){var i=Array.prototype.slice.call(arguments),t=i.shift(),s=t.apply(this,i);return s.physics=this.physics.clone(s),s}function D(i,t,s,e){var n,o,r;return i instanceof THREE.Geometry?(o=i,n=new THREE.Mesh(o,t),r=s):(n=i,t instanceof THREE.Geometry?(o=t,r=s):(o=n.geometry,r=t)),n.rotationAutoUpdate=!1,n.matrixAutoUpdate=!1,n.physics=new E(n,o,r,e),n.clone=O.bind(n,n.clone),n}function T(i,t){var s=[],e=new THREE.Vector3,n=new THREE.Quaternion;i.updateMatrix(),i.updateMatrixWorld(!0);var o=(new THREE.Matrix4).getInverse(i.matrixWorld),r=new THREE.Matrix4;return i.traverse(function(a){if(a.updateMatrix(),a.updateMatrixWorld(!0),a.physics instanceof E){var c;null!=t?c=t(a.physics.geometry):i!==a&&(c=a.physics.getShapeDefinition(a.physics.geometry)),null!=c&&(r.copy(a.matrixWorld).multiply(o),e.setFromMatrixPosition(r),n.setFromRotationMatrix(r),s.push({position:{x:e.x,y:e.y,z:e.z},quaternion:{x:n._x,y:n._y,z:n._z,w:n._w},shape_definition:c}))}}),{body_type:z.COMPOUND,shapes:s}}function m(i,t){if(null==t)throw new Error("Physijs: attempted to create rigid body without specifying physics details");return i.physics instanceof E?i.physics.getShapeDefinition=T.bind(null,i,i.physics.getShapeDefinition):i.physics=new E(i,null,t,T.bind(null,i)),i.rotationAutoUpdate=!1,i.matrixAutoUpdate=!1,i.clone=O.bind(i,i.clone),i}function b(i){var t=i.vertices.reduce(function(i,t){return i.push(t.x,t.y,t.z),i},[]),s=i.faces.reduce(function(i,t){return i.push(t.a,t.b,t.c),i},[]);return{body_type:z.TRIANGLE,vertices:t,faces:s}}function S(i,t,s){return D.call(this,i,t,s,b)}function B(i){return i.computeBoundingSphere(),{body_type:z.SPHERE,radius:i.boundingSphere.radius}}function j(i,t,s){return D.call(this,i,t,s,B)}function A(i){return i.computeBoundingBox(),{body_type:z.PLANE,width:i.boundingBox.max.x,height:i.boundingBox.max.y}}function G(i,t,s){return D.call(this,i,t,s,A)}function v(i){return i.computeBoundingBox(),{body_type:z.CYLINDER,radius:i.boundingBox.max.x,height:i.boundingBox.max.y}}function N(i,t,s){return D.call(this,i,t,s,v)}function L(i){var t=i.vertices.reduce(function(i,t){return i.push(t.x,t.y,t.z),i},[]);return{body_type:z.CONVEX,vertices:t}}function x(i,t,s){return D.call(this,i,t,s,L)}function M(i){return i.computeBoundingBox(),{body_type:z.CONE,radius:i.boundingBox.max.x,height:i.boundingBox.max.y}}function Y(i,t,s){return D.call(this,i,t,s,M)}function C(i){return i.computeBoundingBox(),{body_type:z.BOX,width:i.boundingBox.max.x,height:i.boundingBox.max.y,depth:i.boundingBox.max.z}}function w(i,t,s){return D.call(this,i,t,s,C)}var P={REPORTS:{WORLD:0,COLLISIONS:1},INITIALIZE:"INITIALIZE",ADD_RIGIDBODY:"ADD_RIGIDBODY",REMOVE_RIGIDBODY:"REMOVE_RIGIDBODY",SET_RIGIDBODY_MASS:"SET_RIGIDBODY_MASS",SET_RIGIDBODY_RESTITUTION:"SET_RIGIDBODY_RESTITUTION",SET_RIGIDBODY_FRICTION:"SET_RIGIDBODY_FRICTION",SET_RIGIDBODY_LINEAR_DAMPING:"SET_RIGIDBODY_LINEAR_DAMPING",SET_RIGIDBODY_ANGULAR_DAMPING:"SET_RIGIDBODY_ANGULAR_DAMPING",SET_RIGIDBODY_COLLISION_GROUPS:"SET_RIGIDBODY_COLLISION_GROUPS",SET_RIGIDBODY_COLLISION_MASK:"SET_RIGIDBODY_COLLISION_MASK",SET_RIGIDBODY_TRANSFORM:"SET_RIGIDBODY_TRANSFORM",SET_RIGIDBODY_LINEAR_VELOCITY:"SET_RIGIDBODY_LINEAR_VELOCITY",SET_RIGIDBODY_ANGULAR_VELOCITY:"SET_RIGIDBODY_ANGULAR_VELOCITY",SET_RIGIDBODY_LINEAR_FACTOR:"SET_RIGIDBODY_LINEAR_FACTOR",SET_RIGIDBODY_ANGULAR_FACTOR:"SET_RIGIDBODY_ANGULAR_FACTOR",STEP_SIMULATION:"STEP_SIMULATION"},V=new THREE.Vector3,H=new THREE.Vector3,U=new THREE.Vector3,F=new THREE.Vector3;R.prototype=Object.create(THREE.Scene.prototype),R.prototype.constructor=R;var k=0;Object.defineProperty(E.prototype,"mass",{get:function(){return this._.mass},set:function(i){this._.mass=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyMass(this)}}),Object.defineProperty(E.prototype,"restitution",{get:function(){return this._.restitution},set:function(i){this._.restitution=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyRestitution(this)}}),Object.defineProperty(E.prototype,"friction",{get:function(){return this._.friction},set:function(i){this._.friction=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyFriction(this)}}),Object.defineProperty(E.prototype,"linear_damping",{get:function(){return this._.linear_damping},set:function(i){this._.linear_damping=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyLinearDamping(this)}}),Object.defineProperty(E.prototype,"angular_damping",{get:function(){return this._.angular_damping},set:function(i){this._.angular_damping=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyAngularDamping(this)}}),Object.defineProperty(E.prototype,"collision_groups",{get:function(){return this._.collision_groups},set:function(i){this._.collision_groups=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyCollisionGroups(this)}}),Object.defineProperty(E.prototype,"collision_mask",{get:function(){return this._.collision_mask},set:function(i){this._.collision_mask=i,null!=this.three_object.parent&&this.three_object.parent.physijs.setRigidBodyCollisionMask(this)}}),R.prototype.add=function(i){if(THREE.Scene.prototype.add.call(this,i),i.physics instanceof E){var t=I(i);this.physijs.id_body_map[t.body_id]=i,this.physijs.postMessage(P.ADD_RIGIDBODY,t),i.updateMatrix()}},R.prototype.remove=function(i){THREE.Scene.prototype.remove.call(this,i),i.physics instanceof E&&(delete this.physijs.id_body_map[i.physics._.id],this.physijs.postMessage(P.REMOVE_RIGIDBODY,{body_id:i.physics._.id}))},R.prototype.step=function(i,t,s){if(this.physijs.is_stepping===!0)throw new Error("Physijs: scene is already stepping, cannot call step() until it's finished");this.physijs.is_stepping=!0,this.physijs.onStep=s;for(var e=Object.keys(this.physijs.id_body_map),n=0;n<e.length;n++){var o=e[n],r=this.physijs.id_body_map[o];null!=r&&(r.position.equals(r.physics._.position)&&r.quaternion.equals(r.physics._.quaternion)||this.physijs.setRigidBodyTransform(r),r.physics.linear_velocity.equals(r.physics._.linear_velocity)||this.physijs.setRigidBodyLinearVelocity(r),r.physics.angular_velocity.equals(r.physics._.angular_velocity)||this.physijs.setRigidBodyAngularVelocity(r),r.physics.linear_factor.equals(r.physics._.linear_factor)||(this.physijs.setRigidBodyLinearFactor(r),r.physics._.linear_factor.copy(r.physics.linear_factor)),r.physics.angular_factor.equals(r.physics._.angular_factor)||(this.physijs.setRigidBodyAngularFactor(r),r.physics._.angular_factor.copy(r.physics.angular_factor)))}this.physijs.postMessage(P.STEP_SIMULATION,{time_delta:i,max_step:t})};var z={BOX:"BOX",COMPOUND:"COMPOUND",CONE:"CONE",CONVEX:"CONVEX",CYLINDER:"CYLINDER",PLANE:"PLANE",SPHERE:"SPHERE",TRIANGLE:"TRIANGLE"},q={PhysicsObject:D,Box:w,Cone:Y,Convex:x,Cylinder:N,Plane:G,Sphere:j,TriangleMesh:S,CompoundObject:m,Scene:R};return q});