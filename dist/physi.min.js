!function(i,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):i.physijs=s()}(this,function(){"use strict";function i(i,s){this.physijs.postMessage(O.SET_RIGIDBODY_ANGULAR_FACTOR,{body_id:i,factor:{x:s.angular_factor.x,y:s.angular_factor.y,z:s.angular_factor.z}})}function s(i,s){this.physijs.postMessage(O.SET_RIGIDBODY_LINEAR_FACTOR,{body_id:i,factor:{x:s.linear_factor.x,y:s.linear_factor.y,z:s.linear_factor.z}})}function t(i,s){this.physijs.postMessage(O.SET_RIGIDBODY_ANGULAR_VELOCITY,{body_id:i,velocity:{x:s.angular_velocity.x,y:s.angular_velocity.y,z:s.angular_velocity.z}})}function o(i,s){this.physijs.postMessage(O.SET_RIGIDBODY_LINEAR_VELOCITY,{body_id:i,velocity:{x:s.linear_velocity.x,y:s.linear_velocity.y,z:s.linear_velocity.z}})}function e(i,s){this.physijs.postMessage(O.SET_RIGIDBODY_TRANSFORM,{body_id:i,position:{x:s.position.x,y:s.position.y,z:s.position.z},rotation:{x:s.quaternion.x,y:s.quaternion.y,z:s.quaternion.z,w:s.quaternion.w}})}function n(i){this.physijs.postMessage(O.SET_RIGIDBODY_COLLISION_MASK,{body_id:i.physijs.id,collision_mask:i.physijs.collision_mask})}function r(i){this.physijs.postMessage(O.SET_RIGIDBODY_COLLISION_GROUPS,{body_id:i.physijs.id,collision_groups:i.physijs.collision_groups})}function p(i){this.physijs.postMessage(O.SET_RIGIDBODY_ANGULAR_DAMPING,{body_id:i.physijs.id,damping:i.physijs.angular_damping})}function a(i){this.physijs.postMessage(O.SET_RIGIDBODY_LINEAR_DAMPING,{body_id:i.physijs.id,damping:i.physijs.linear_damping})}function y(i){this.physijs.postMessage(O.SET_RIGIDBODY_FRICTION,{body_id:i.physijs.id,friction:i.physijs.friction})}function h(i){this.physijs.postMessage(O.SET_RIGIDBODY_RESTITUTION,{body_id:i.physijs.id,restitution:i.physijs.restitution})}function _(i){this.physijs.postMessage(O.SET_RIGIDBODY_MASS,{body_id:i.physijs.id,mass:i.physijs.mass})}function d(i){this.physijs.worker.postMessage(i,[i.buffer])}function c(i,s){this.physijs.worker.postMessage({type:i,parameters:s})}function l(i){for(var s=i[1],t=0;s>t;t++){var o=2+30*t,e=i[o++],n=this.physijs.id_rigid_body_map[e];n.matrix.set(i[o++],i[o++],i[o++],i[o++],i[o++],i[o++],i[o++],i[o++],i[o++],i[o++],i[o++],i[o++],i[o++],i[o++],i[o++],i[o++]),n.position.copy(n.physijs.position.set(i[o++],i[o++],i[o++])),n.quaternion.copy(n.physijs.quaternion.set(i[o++],i[o++],i[o++],i[o++])),n.linear_velocity.copy(n.physijs.linear_velocity.set(i[o++],i[o++],i[o++])),n.angular_velocity.copy(n.physijs.angular_velocity.set(i[o++],i[o++],i[o++]))}if(this.physijs.postReport(i),this.physijs.is_stepping=!1,this.physijs.onStep instanceof Function){var r=this.physijs.onStep;this.physijs.onStep=null,r.call(this)}}function u(i,s){this.physijs.worker=new Worker(i),this.physijs.worker.addEventListener("message",function(i){var s=i.data;if(s instanceof Float32Array){var t=s[0];t===O.REPORTS.WORLD&&this.physijs.processWorldReport(s)}}.bind(this)),this.physijs.postMessage(O.INITIALIZE,s||{})}function I(I,g){THREE.Scene.call(this),this.physijs={is_stepping:!1,id_rigid_body_map:{},onStep:null,initializeWorker:u.bind(this),processWorldReport:l.bind(this),postMessage:c.bind(this),postReport:d.bind(this),setRigidBodyMass:_.bind(this),setRigidBodyRestitution:h.bind(this),setRigidBodyFriction:y.bind(this),setRigidBodyLinearDamping:a.bind(this),setRigidBodyAngularDamping:p.bind(this),setRigidBodyCollisionGroups:r.bind(this),setRigidBodyCollisionMask:n.bind(this),setRigidBodyTransform:e.bind(this),setRigidBodyLinearVelocity:o.bind(this),setRigidBodyAngularVelocity:t.bind(this),setRigidBodyLinearFactor:s.bind(this),setRigidBodyAngularFactor:i.bind(this)},this.physijs.initializeWorker(I,g)}function g(){return T++}function R(i,s,t){if(null==t)throw new Error("Physijs: attempted to create rigid body without specifying physics details");THREE.Mesh.call(this,i,s),this.rotationAutoUpdate=!1,this.matrixAutoUpdate=!1,this.physijs={id:g(),mass:t.mass||1/0,restitution:t.restitution||.1,friction:t.friction||.5,linear_damping:t.linear_damping||0,angular_damping:t.angular_damping||0,collision_groups:0,collision_mask:0,position:new THREE.Vector3,quaternion:new THREE.Quaternion,linear_velocity:new THREE.Vector3,angular_velocity:new THREE.Vector3,linear_factor:new THREE.Vector3(1,1,1),angular_factor:new THREE.Vector3(1,1,1)},this.linear_velocity=new THREE.Vector3,this.angular_velocity=new THREE.Vector3,this.linear_factor=new THREE.Vector3(1,1,1),this.angular_factor=new THREE.Vector3(1,1,1)}function j(i,s,t){R.call(this,i,s,t)}function f(i,s,t){R.call(this,i,s,t)}function E(i){var s,t={};if(i instanceof f)i.geometry.computeBoundingSphere(),s=D.SPHERE,t.radius=i.geometry.boundingSphere.radius;else{if(!(i instanceof j))throw new Error("Physijs: unable to determine rigid body definition for mesh");i.geometry.computeBoundingBox(),s=D.BOX,t.width=i.geometry.boundingBox.max.x,t.height=i.geometry.boundingBox.max.y,t.depth=i.geometry.boundingBox.max.z}return{body_id:i.physijs.id,body_type:s,body_definition:t,mass:i.physijs.mass,restitution:i.physijs.restitution,friction:i.physijs.friction,linear_damping:i.physijs.linear_damping,angular_damping:i.physijs.angular_damping,collision_groups:i.physijs.collision_groups,collision_mask:i.physijs.collision_mask}}var O={REPORTS:{WORLD:0},INITIALIZE:"INITIALIZE",ADD_RIGIDBODY:"ADD_RIGIDBODY",SET_RIGIDBODY_MASS:"SET_RIGIDBODY_MASS",SET_RIGIDBODY_RESTITUTION:"SET_RIGIDBODY_RESTITUTION",SET_RIGIDBODY_FRICTION:"SET_RIGIDBODY_FRICTION",SET_RIGIDBODY_LINEAR_DAMPING:"SET_RIGIDBODY_LINEAR_DAMPING",SET_RIGIDBODY_ANGULAR_DAMPING:"SET_RIGIDBODY_ANGULAR_DAMPING",SET_RIGIDBODY_COLLISION_GROUPS:"SET_RIGIDBODY_COLLISION_GROUPS",SET_RIGIDBODY_COLLISION_MASK:"SET_RIGIDBODY_COLLISION_MASK",SET_RIGIDBODY_TRANSFORM:"SET_RIGIDBODY_TRANSFORM",SET_RIGIDBODY_LINEAR_VELOCITY:"SET_RIGIDBODY_LINEAR_VELOCITY",SET_RIGIDBODY_ANGULAR_VELOCITY:"SET_RIGIDBODY_ANGULAR_VELOCITY",SET_RIGIDBODY_LINEAR_FACTOR:"SET_RIGIDBODY_LINEAR_FACTOR",SET_RIGIDBODY_ANGULAR_FACTOR:"SET_RIGIDBODY_ANGULAR_FACTOR",STEP_SIMULATION:"STEP_SIMULATION"};I.prototype=Object.create(THREE.Scene.prototype),I.prototype.constructor=I;var D={SPHERE:"SPHERE",BOX:"BOX"},T=0;R.prototype=Object.create(THREE.Mesh.prototype),R.prototype.constructor=R,Object.defineProperty(R.prototype,"mass",{get:function(){return this.physijs.mass},set:function(i){this.physijs.mass=i,null!=this.parent&&this.parent.physijs.setRigidBodyMass(this)}}),Object.defineProperty(R.prototype,"restitution",{get:function(){return this.physijs.restitution},set:function(i){this.physijs.restitution=i,null!=this.parent&&this.parent.physijs.setRigidBodyRestitution(this)}}),Object.defineProperty(R.prototype,"friction",{get:function(){return this.physijs.friction},set:function(i){this.physijs.friction=i,null!=this.parent&&this.parent.physijs.setRigidBodyFriction(this)}}),Object.defineProperty(R.prototype,"linear_damping",{get:function(){return this.physijs.linear_damping},set:function(i){this.physijs.linear_damping=i,null!=this.parent&&this.parent.physijs.setRigidBodyLinearDamping(this)}}),Object.defineProperty(R.prototype,"angular_damping",{get:function(){return this.physijs.angular_damping},set:function(i){this.physijs.angular_damping=i,null!=this.parent&&this.parent.physijs.setRigidBodyAngularDamping(this)}}),Object.defineProperty(R.prototype,"collision_groups",{get:function(){return this.physijs.collision_groups},set:function(i){this.physijs.collision_groups=i,null!=this.parent&&this.parent.physijs.setRigidBodyCollisionGroups(this)}}),Object.defineProperty(R.prototype,"collision_mask",{get:function(){return this.physijs.collision_mask},set:function(i){this.physijs.collision_mask=i,null!=this.parent&&this.parent.physijs.setRigidBodyCollisionMask(this)}}),j.prototype=Object.create(R.prototype),j.prototype.constructor=j,f.prototype=Object.create(R.prototype),f.prototype.constructor=f,I.prototype.add=function(i){if(THREE.Scene.prototype.add.call(this,i),i instanceof R){var s=E(i);this.physijs.id_rigid_body_map[s.body_id]=i,this.physijs.postMessage(O.ADD_RIGIDBODY,s)}},I.prototype.step=function(i,s,t){if(this.physijs.is_stepping===!0)throw new Error("Physijs: scene is already stepping, cannot call step() until it's finished");this.physijs.is_stepping=!0,this.physijs.onStep=t;for(var o=Object.keys(this.physijs.id_rigid_body_map),e=0;e<o.length;e++){var n=o[e],r=this.physijs.id_rigid_body_map[n];r.position.equals(r.physijs.position)&&r.quaternion.equals(r.physijs.quaternion)||this.physijs.setRigidBodyTransform(n,r),r.linear_velocity.equals(r.physijs.linear_velocity)||this.physijs.setRigidBodyLinearVelocity(n,r),r.angular_velocity.equals(r.physijs.angular_velocity)||this.physijs.setRigidBodyAngularVelocity(n,r),r.linear_factor.equals(r.physijs.linear_factor)||(this.physijs.setRigidBodyLinearFactor(n,r),r.physijs.linear_factor.copy(r.linear_factor)),r.angular_factor.equals(r.physijs.angular_factor)||(this.physijs.setRigidBodyAngularFactor(n,r),r.physijs.angular_factor.copy(r.angular_factor))}this.physijs.postMessage(O.STEP_SIMULATION,{time_delta:i,max_step:s})};var S={Mesh:R,BoxMesh:j,SphereMesh:f,Scene:I};return S});