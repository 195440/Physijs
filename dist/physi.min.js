!function(i,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):i.physijs=s()}(this,function(){"use strict";function i(i,s,t){if(this.physijs.is_stepping===!0)throw new Error("Physijs: scene is already stepping, cannot call step() until it's finished");this.physijs.is_stepping=!0,this.physijs.onStep=t;for(var e=Object.keys(this.physijs.id_rigid_body_map),o=0;o<e.length;o++){var n=e[o],p=this.physijs.id_rigid_body_map[n];p.position.equals(p.physijs.position)&&p.quaternion.equals(p.physijs.quaternion)||this.physijs.setRigidBodyTransform(n,p)}this.physijs.postMessage(u.STEP_SIMULATION,{time_delta:i,max_step:s})}function s(i,s){this.physijs.postMessage(u.SET_RIGIDBODY_TRANSFORM,{body_id:i,position:{x:s.position.x,y:s.position.y,z:s.position.z},rotation:{x:s.quaternion.x,y:s.quaternion.y,z:s.quaternion.z,w:s.quaternion.w}})}function t(i){this.physijs.postMessage(u.SET_RIGIDBODY_MASS,{body_id:i.physijs.id,mass:i.physijs.mass})}function e(i){this.physijs.worker.postMessage(i,[i.buffer])}function o(i,s){this.physijs.worker.postMessage({type:i,parameters:s})}function n(i){for(var s=i[1],t=0;s>t;t++){var e=2+24*t,o=i[e++],n=this.physijs.id_rigid_body_map[o];n.matrix.set(i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++]),n.position.copy(n.physijs.position.set(i[e++],i[e++],i[e++])),n.quaternion.copy(n.physijs.quaternion.set(i[e++],i[e++],i[e++],i[e++]))}if(this.physijs.postReport(i),this.physijs.is_stepping=!1,this.physijs.onStep instanceof Function){var p=this.physijs.onStep;this.physijs.onStep=null,p.call(this)}}function p(i,s){this.physijs.worker=new Worker(i),this.physijs.worker.addEventListener("message",function(i){var s=i.data;if(s instanceof Float32Array){var t=s[0];t===u.REPORTS.WORLD&&this.physijs.processWorldReport(s)}}.bind(this)),this.physijs.postMessage(u.INITIALIZE,s||{})}function r(r,h){THREE.Scene.call(this),this.physijs={is_stepping:!1,id_rigid_body_map:{},onStep:null,initializeWorker:p.bind(this),processWorldReport:n.bind(this),postMessage:o.bind(this),postReport:e.bind(this),setRigidBodyMass:t.bind(this),setRigidBodyTransform:s.bind(this),step:i.bind(this)},this.physijs.initializeWorker(r,h)}function h(){return j++}function a(i,s,t){if(null==t)throw new Error("Physijs: attempted to create rigid body without specifying mass");THREE.Mesh.call(this,i,s),this.rotationAutoUpdate=!1,this.matrixAutoUpdate=!1,this.physijs={id:h(),mass:t||1/0,position:new THREE.Vector3,quaternion:new THREE.Quaternion}}function y(i,s,t){a.call(this,i,s,t)}function d(i,s,t){a.call(this,i,s,t)}function c(i){var s,t={};if(i instanceof d)i.geometry.computeBoundingSphere(),s=f.SPHERE,t.radius=i.geometry.boundingSphere.radius;else{if(!(i instanceof y))throw new Error("Physijs: unable to determine rigid body definition for mesh");i.geometry.computeBoundingBox(),s=f.BOX,t.width=i.geometry.boundingBox.max.x,t.height=i.geometry.boundingBox.max.y,t.depth=i.geometry.boundingBox.max.z}return{body_id:i.physijs.id,body_type:s,body_definition:t,mass:i.physijs.mass}}var u={REPORTS:{WORLD:0},INITIALIZE:"INITIALIZE",ADD_RIGIDBODY:"ADD_RIGIDBODY",SET_RIGIDBODY_MASS:"SET_RIGIDBODY_MASS",SET_RIGIDBODY_TRANSFORM:"SET_RIGIDBODY_TRANSFORM",STEP_SIMULATION:"STEP_SIMULATION"};r.prototype=Object.create(THREE.Scene.prototype),r.prototype.constructor=r;var f={SPHERE:"SPHERE",BOX:"BOX"},j=0;a.prototype=Object.create(THREE.Mesh.prototype),a.prototype.constructor=a,Object.defineProperty(a.prototype,"mass",{get:function(){return this.physijs.mass},set:function(i){this.physijs.mass=i,null!=this.parent&&this.parent.setRigidBodyMass(this)}}),y.prototype=Object.create(a.prototype),y.prototype.constructor=y,d.prototype=Object.create(a.prototype),d.prototype.constructor=d,r.prototype.add=function(i){if(THREE.Scene.prototype.add.call(this,i),i instanceof a){var s=c(i);this.physijs.id_rigid_body_map[s.body_id]=i,this.physijs.postMessage(u.ADD_RIGIDBODY,s),this.physijs.setRigidBodyTransform(s.body_id,i)}};var _={Mesh:a,BoxMesh:y,SphereMesh:d,Scene:r};return _});