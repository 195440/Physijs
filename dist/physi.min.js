!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):t.physijs=i()}(this,function(){"use strict";function t(t,i){THREE.Scene.call(this),this.initializeWorker(t,i),this.physijs={is_stepping:!1,id_rigid_body_map:{},onStep:null}}function i(){return a++}function s(t,s,o){if(null==o)throw new Error("Physijs: attempted to create rigid body without specifying mass");THREE.Mesh.call(this,t,s),this.rotationAutoUpdate=!1,this.matrixAutoUpdate=!1,this.physijs={id:i(),mass:o||1/0,position:new THREE.Vector3,quaternion:new THREE.Quaternion}}function o(t,i,o){s.call(this,t,i,o)}function e(t,i,o){s.call(this,t,i,o)}function n(t){var i,s={};if(t instanceof e)t.geometry.computeBoundingSphere(),i=p.SPHERE,s.radius=t.geometry.boundingSphere.radius;else{if(!(t instanceof o))throw new Error("Physijs: unable to determine rigid body definition for mesh");t.geometry.computeBoundingBox(),i=p.BOX,s.width=t.geometry.boundingBox.max.x,s.height=t.geometry.boundingBox.max.y,s.depth=t.geometry.boundingBox.max.z}return{body_id:t.physijs.id,body_type:i,body_definition:s,mass:t.physijs.mass}}t.prototype=Object.create(THREE.Scene.prototype),t.prototype.constructor=t;var r={REPORTS:{WORLD:0},INITIALIZE:"INITIALIZE",ADD_RIGIDBODY:"ADD_RIGIDBODY",SET_RIGIDBODY_MASS:"SET_RIGIDBODY_MASS",SET_RIGIDBODY_TRANSFORM:"SET_RIGIDBODY_TRANSFORM",STEP_SIMULATION:"STEP_SIMULATION"};t.prototype.initializeWorker=function(t,i){this.worker=new Worker(t),this.worker.addEventListener("message",function(t){var i=t.data;if(i instanceof Float32Array){var s=i[0];s===r.REPORTS.WORLD&&this.processWorldReport(i)}}.bind(this)),this.postMessage(r.INITIALIZE,i||{})},t.prototype.processWorldReport=function(t){for(var i=t[1],s=0;i>s;s++){var o=2+24*s,e=t[o++],n=this.physijs.id_rigid_body_map[e];n.matrix.set(t[o++],t[o++],t[o++],t[o++],t[o++],t[o++],t[o++],t[o++],t[o++],t[o++],t[o++],t[o++],t[o++],t[o++],t[o++],t[o++]),n.position.copy(n.physijs.position.set(t[o++],t[o++],t[o++])),n.quaternion.copy(n.physijs.quaternion.set(t[o++],t[o++],t[o++],t[o++]))}if(this.postReport(t),this.physijs.is_stepping=!1,this.physijs.onStep instanceof Function){var r=this.physijs.onStep;this.physijs.onStep=null,r.call(this)}},t.prototype.postMessage=function(t,i){this.worker.postMessage({type:t,parameters:i})},t.prototype.postReport=function(t){this.worker.postMessage(t,[t.buffer])};var p={SPHERE:"SPHERE",BOX:"BOX"},a=0;s.prototype=Object.create(THREE.Mesh.prototype),s.prototype.constructor=s,Object.defineProperty(s.prototype,"mass",{get:function(){return this.physijs.mass},set:function(t){this.physijs.mass=t,null!=this.parent&&this.parent.setRigidBodyMass(this)}}),o.prototype=Object.create(s.prototype),o.prototype.constructor=o,e.prototype=Object.create(s.prototype),e.prototype.constructor=e,t.prototype.add=function(t){if(THREE.Scene.prototype.add.call(this,t),t instanceof s){var i=n(t);this.physijs.id_rigid_body_map[i.body_id]=t,this.postMessage(r.ADD_RIGIDBODY,i),this.setRigidBodyTransform(i.body_id,t)}},t.prototype.setRigidBodyMass=function(t){this.postMessage(r.SET_RIGIDBODY_MASS,{body_id:t.physijs.id,mass:t.physijs.mass})},t.prototype.setRigidBodyTransform=function(t,i){this.postMessage(r.SET_RIGIDBODY_TRANSFORM,{body_id:t,position:{x:i.position.x,y:i.position.y,z:i.position.z},rotation:{x:i.quaternion.x,y:i.quaternion.y,z:i.quaternion.z,w:i.quaternion.w}})},t.prototype.step=function(t,i,s){if(this.physijs.is_stepping===!0)throw new Error("Physijs: scene is already stepping, cannot call step() until it's finished");this.physijs.is_stepping=!0,this.physijs.onStep=s;for(var o=Object.keys(this.physijs.id_rigid_body_map),e=0;e<o.length;e++){var n=o[e],p=this.physijs.id_rigid_body_map[n];p.position.equals(p.physijs.position)&&p.quaternion.equals(p.physijs.quaternion)||this.setRigidBodyTransform(n,p)}this.postMessage(r.STEP_SIMULATION,{time_delta:t,max_step:i})};var y={Mesh:s,BoxMesh:o,SphereMesh:e,Scene:t};return y});