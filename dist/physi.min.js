!function(i,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):i.physijs=t()}(this,function(){"use strict";function i(i,t){this.physijs.postMessage(E.SET_RIGIDBODY_ANGULAR_FACTOR,{body_id:i,factor:{x:t.angular_factor.x,y:t.angular_factor.y,z:t.angular_factor.z}})}function t(i,t){this.physijs.postMessage(E.SET_RIGIDBODY_LINEAR_FACTOR,{body_id:i,factor:{x:t.linear_factor.x,y:t.linear_factor.y,z:t.linear_factor.z}})}function s(i,t){this.physijs.postMessage(E.SET_RIGIDBODY_ANGULAR_VELOCITY,{body_id:i,velocity:{x:t.angular_velocity.x,y:t.angular_velocity.y,z:t.angular_velocity.z}})}function e(i,t){this.physijs.postMessage(E.SET_RIGIDBODY_LINEAR_VELOCITY,{body_id:i,velocity:{x:t.linear_velocity.x,y:t.linear_velocity.y,z:t.linear_velocity.z}})}function o(i,t){this.physijs.postMessage(E.SET_RIGIDBODY_TRANSFORM,{body_id:i,position:{x:t.position.x,y:t.position.y,z:t.position.z},rotation:{x:t.quaternion.x,y:t.quaternion.y,z:t.quaternion.z,w:t.quaternion.w}})}function n(i){this.physijs.postMessage(E.SET_RIGIDBODY_ANGULAR_DAMPING,{body_id:i.physijs.id,damping:i.physijs.angular_damping})}function r(i){this.physijs.postMessage(E.SET_RIGIDBODY_LINEAR_DAMPING,{body_id:i.physijs.id,damping:i.physijs.linear_damping})}function a(i){this.physijs.postMessage(E.SET_RIGIDBODY_FRICTION,{body_id:i.physijs.id,friction:i.physijs.friction})}function p(i){this.physijs.postMessage(E.SET_RIGIDBODY_RESTITUTION,{body_id:i.physijs.id,restitution:i.physijs.restitution})}function y(i){this.physijs.postMessage(E.SET_RIGIDBODY_MASS,{body_id:i.physijs.id,mass:i.physijs.mass})}function h(i){this.physijs.worker.postMessage(i,[i.buffer])}function _(i,t){this.physijs.worker.postMessage({type:i,parameters:t})}function d(i){for(var t=i[1],s=0;t>s;s++){var e=2+30*s,o=i[e++],n=this.physijs.id_rigid_body_map[o];n.matrix.set(i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++],i[e++]),n.position.copy(n.physijs.position.set(i[e++],i[e++],i[e++])),n.quaternion.copy(n.physijs.quaternion.set(i[e++],i[e++],i[e++],i[e++])),n.linear_velocity.copy(n.physijs.linear_velocity.set(i[e++],i[e++],i[e++])),n.angular_velocity.copy(n.physijs.angular_velocity.set(i[e++],i[e++],i[e++]))}if(this.physijs.postReport(i),this.physijs.is_stepping=!1,this.physijs.onStep instanceof Function){var r=this.physijs.onStep;this.physijs.onStep=null,r.call(this)}}function c(i,t){this.physijs.worker=new Worker(i),this.physijs.worker.addEventListener("message",function(i){var t=i.data;if(t instanceof Float32Array){var s=t[0];s===E.REPORTS.WORLD&&this.physijs.processWorldReport(t)}}.bind(this)),this.physijs.postMessage(E.INITIALIZE,t||{})}function u(u,l){THREE.Scene.call(this),this.physijs={is_stepping:!1,id_rigid_body_map:{},onStep:null,initializeWorker:c.bind(this),processWorldReport:d.bind(this),postMessage:_.bind(this),postReport:h.bind(this),setRigidBodyMass:y.bind(this),setRigidBodyRestitution:p.bind(this),setRigidBodyFriction:a.bind(this),setRigidBodyLinearDamping:r.bind(this),setRigidBodyAngularDamping:n.bind(this),setRigidBodyTransform:o.bind(this),setRigidBodyLinearVelocity:e.bind(this),setRigidBodyAngularVelocity:s.bind(this),setRigidBodyLinearFactor:t.bind(this),setRigidBodyAngularFactor:i.bind(this)},this.physijs.initializeWorker(u,l)}function l(){return T++}function R(i,t,s){if(null==s)throw new Error("Physijs: attempted to create rigid body without specifying physics details");THREE.Mesh.call(this,i,t),this.rotationAutoUpdate=!1,this.matrixAutoUpdate=!1,this.physijs={id:l(),mass:s.mass||1/0,restitution:s.restitution||.1,friction:s.friction||.5,linear_damping:s.linear_damping||0,angular_damping:s.angular_damping||0,position:new THREE.Vector3,quaternion:new THREE.Quaternion,linear_velocity:new THREE.Vector3,angular_velocity:new THREE.Vector3,linear_factor:new THREE.Vector3(1,1,1),angular_factor:new THREE.Vector3(1,1,1)},this.linear_velocity=new THREE.Vector3,this.angular_velocity=new THREE.Vector3,this.linear_factor=new THREE.Vector3(1,1,1),this.angular_factor=new THREE.Vector3(1,1,1)}function g(i,t,s){R.call(this,i,t,s)}function I(i,t,s){R.call(this,i,t,s)}function f(i){var t,s={};if(i instanceof I)i.geometry.computeBoundingSphere(),t=j.SPHERE,s.radius=i.geometry.boundingSphere.radius;else{if(!(i instanceof g))throw new Error("Physijs: unable to determine rigid body definition for mesh");i.geometry.computeBoundingBox(),t=j.BOX,s.width=i.geometry.boundingBox.max.x,s.height=i.geometry.boundingBox.max.y,s.depth=i.geometry.boundingBox.max.z}return{body_id:i.physijs.id,body_type:t,body_definition:s,mass:i.physijs.mass,restitution:i.physijs.restitution,friction:i.physijs.friction}}var E={REPORTS:{WORLD:0},INITIALIZE:"INITIALIZE",ADD_RIGIDBODY:"ADD_RIGIDBODY",SET_RIGIDBODY_MASS:"SET_RIGIDBODY_MASS",SET_RIGIDBODY_RESTITUTION:"SET_RIGIDBODY_RESTITUTION",SET_RIGIDBODY_FRICTION:"SET_RIGIDBODY_FRICTION",SET_RIGIDBODY_LINEAR_DAMPING:"SET_RIGIDBODY_LINEAR_DAMPING",SET_RIGIDBODY_ANGULAR_DAMPING:"SET_RIGIDBODY_ANGULAR_DAMPING",SET_RIGIDBODY_TRANSFORM:"SET_RIGIDBODY_TRANSFORM",SET_RIGIDBODY_LINEAR_VELOCITY:"SET_RIGIDBODY_LINEAR_VELOCITY",SET_RIGIDBODY_ANGULAR_VELOCITY:"SET_RIGIDBODY_ANGULAR_VELOCITY",SET_RIGIDBODY_LINEAR_FACTOR:"SET_RIGIDBODY_LINEAR_FACTOR",SET_RIGIDBODY_ANGULAR_FACTOR:"SET_RIGIDBODY_ANGULAR_FACTOR",STEP_SIMULATION:"STEP_SIMULATION"};u.prototype=Object.create(THREE.Scene.prototype),u.prototype.constructor=u;var j={SPHERE:"SPHERE",BOX:"BOX"},T=0;R.prototype=Object.create(THREE.Mesh.prototype),R.prototype.constructor=R,Object.defineProperty(R.prototype,"mass",{get:function(){return this.physijs.mass},set:function(i){this.physijs.mass=i,null!=this.parent&&this.parent.physijs.setRigidBodyMass(this)}}),Object.defineProperty(R.prototype,"restitution",{get:function(){return this.physijs.restitution},set:function(i){this.physijs.restitution=i,null!=this.parent&&this.parent.physijs.setRigidBodyRestitution(this)}}),Object.defineProperty(R.prototype,"friction",{get:function(){return this.physijs.friction},set:function(i){this.physijs.friction=i,null!=this.parent&&this.parent.physijs.setRigidBodyFriction(this)}}),Object.defineProperty(R.prototype,"linear_damping",{get:function(){return this.physijs.linear_damping},set:function(i){this.physijs.linear_damping=i,null!=this.parent&&this.parent.physijs.setRigidBodyLinearDamping(this)}}),Object.defineProperty(R.prototype,"angular_damping",{get:function(){return this.physijs.angular_damping},set:function(i){this.physijs.angular_damping=i,null!=this.parent&&this.parent.physijs.setRigidBodyAngularDamping(this)}}),g.prototype=Object.create(R.prototype),g.prototype.constructor=g,I.prototype=Object.create(R.prototype),I.prototype.constructor=I,u.prototype.add=function(i){if(THREE.Scene.prototype.add.call(this,i),i instanceof R){var t=f(i);this.physijs.id_rigid_body_map[t.body_id]=i,this.physijs.postMessage(E.ADD_RIGIDBODY,t),this.physijs.setRigidBodyTransform(t.body_id,i)}},u.prototype.step=function(i,t,s){if(this.physijs.is_stepping===!0)throw new Error("Physijs: scene is already stepping, cannot call step() until it's finished");this.physijs.is_stepping=!0,this.physijs.onStep=s;for(var e=Object.keys(this.physijs.id_rigid_body_map),o=0;o<e.length;o++){var n=e[o],r=this.physijs.id_rigid_body_map[n];r.position.equals(r.physijs.position)&&r.quaternion.equals(r.physijs.quaternion)||this.physijs.setRigidBodyTransform(n,r),r.linear_velocity.equals(r.physijs.linear_velocity)||this.physijs.setRigidBodyLinearVelocity(n,r),r.angular_velocity.equals(r.physijs.angular_velocity)||this.physijs.setRigidBodyAngularVelocity(n,r),r.linear_factor.equals(r.physijs.linear_factor)||(this.physijs.setRigidBodyLinearFactor(n,r),r.physijs.linear_factor.copy(r.linear_factor)),r.angular_factor.equals(r.physijs.angular_factor)||(this.physijs.setRigidBodyAngularFactor(n,r),r.physijs.angular_factor.copy(r.angular_factor))}this.physijs.postMessage(E.STEP_SIMULATION,{time_delta:i,max_step:t})};var D={Mesh:R,BoxMesh:g,SphereMesh:I,Scene:u};return D});