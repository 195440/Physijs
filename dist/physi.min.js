!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.physijs=e()}(this,function(){"use strict";function t(t,e){THREE.Scene.call(this),this.initializeWorker(t,e),this.physijs={is_stepping:!1,id_rigid_body_map:{},onStep:null}}function e(){return a++}function i(t,i,s){if(null==s)throw new Error("Physijs: attempted to create rigid body without specifying mass");THREE.Mesh.call(this,t,i),this.rotationAutoUpdate=!1,this.matrixAutoUpdate=!1,this.physijs={id:e(),mass:s||1/0}}function s(t,e,s){i.call(this,t,e,s)}function o(t,e,s){i.call(this,t,e,s)}function n(t){var e,i={};if(t instanceof o)t.geometry.computeBoundingSphere(),e=p.SPHERE,i.radius=t.geometry.boundingSphere.radius;else{if(!(t instanceof s))throw new Error("Physijs: unable to determine rigid body definition for mesh");t.geometry.computeBoundingBox(),e=p.BOX,i.width=t.geometry.boundingBox.max.x,i.height=t.geometry.boundingBox.max.y,i.depth=t.geometry.boundingBox.max.z}return{body_id:t.physijs.id,body_type:e,body_definition:i,mass:t.physijs.mass}}t.prototype=Object.create(THREE.Scene.prototype),t.prototype.constructor=t;var r={REPORTS:{WORLD:0},INITIALIZE:"INITIALIZE",ADD_RIGIDBODY:"ADD_RIGIDBODY",SET_RIGIDBODY_MASS:"SET_RIGIDBODY_MASS",SET_RIGIDBODY_TRANSFORM:"SET_RIGIDBODY_TRANSFORM",STEP_SIMULATION:"STEP_SIMULATION"};t.prototype.initializeWorker=function(t,e){this.worker=new Worker(t),this.worker.addEventListener("message",function(t){var e=t.data;if(e instanceof Float32Array){var i=e[0];i===r.REPORTS.WORLD&&this.processWorldReport(e)}}.bind(this)),this.postMessage(r.INITIALIZE,e||{})},t.prototype.processWorldReport=function(t){for(var e=t[1],i=0;e>i;i++){var s=2+17*i,o=t[s++],n=this.physijs.id_rigid_body_map[o];n.matrix.set(t[s++],t[s++],t[s++],t[s++],t[s++],t[s++],t[s++],t[s++],t[s++],t[s++],t[s++],t[s++],t[s++],t[s++],t[s++],t[s++])}if(this.postReport(t),this.physijs.is_stepping=!1,this.physijs.onStep instanceof Function){var r=this.physijs.onStep;this.physijs.onStep=null,r.call(this)}},t.prototype.postMessage=function(t,e){this.worker.postMessage({type:t,parameters:e})},t.prototype.postReport=function(t){this.worker.postMessage(t,[t.buffer])};var p={SPHERE:"SPHERE",BOX:"BOX"},a=0;i.prototype=Object.create(THREE.Mesh.prototype),i.prototype.constructor=i,Object.defineProperty(i.prototype,"mass",{get:function(){return this.physijs.mass},set:function(t){this.physijs.mass=t,null!=this.parent&&this.parent.setRigidBodyMass(this)}}),s.prototype=Object.create(i.prototype),s.prototype.constructor=s,o.prototype=Object.create(i.prototype),o.prototype.constructor=o,t.prototype.add=function(t){if(THREE.Scene.prototype.add.call(this,t),t instanceof i){var e=n(t);this.physijs.id_rigid_body_map[e.body_id]=t,this.postMessage(r.ADD_RIGIDBODY,e),this.postMessage(r.SET_RIGIDBODY_TRANSFORM,{body_id:e.body_id,position:{x:t.position.x,y:t.position.y,z:t.position.z},rotation:{x:t.quaternion.x,y:t.quaternion.y,z:t.quaternion.z,w:t.quaternion.w}})}},t.prototype.setRigidBodyMass=function(t){this.postMessage(r.SET_RIGIDBODY_MASS,{body_id:t.physijs.id,mass:t.physijs.mass})},t.prototype.step=function(t,e,i){if(this.physijs.is_stepping===!0)throw new Error("Physijs: scene is already stepping, cannot call step() until it's finished");this.physijs.is_stepping=!0,this.physijs.onStep=i,this.postMessage(r.STEP_SIMULATION,{time_delta:t,max_step:e})};var h={Mesh:i,BoxMesh:s,SphereMesh:o,Scene:t};return h});